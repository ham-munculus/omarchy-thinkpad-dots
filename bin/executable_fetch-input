#!/usr/bin/env bash
# Wrapper script that runs the actual Python code in the current project's venv.

set -euo pipefail

# Use the current directory as the project root
PROJECT_ROOT="$(pwd)"
VENV_BIN="$PROJECT_ROOT/.venv/bin"

if [[ ! -x "$VENV_BIN/python" ]]; then
    cat >&2 <<EOF
Project venv not found at $VENV_BIN/python.

Create it with something like:
  cd "$PROJECT_ROOT"
  uv venv .venv && uv pip install requests

(Or otherwise ensure .venv/bin/python exists and has 'requests' installed.)
EOF
    exit 1
fi

# Run the embedded Python code via this project's venv python.
exec "$VENV_BIN/python" - "$@" <<'PYCODE'
import os
import sys
from pathlib import Path

def load_session() -> str:
    session = os.environ.get("SESSION")
    if session:
        return session.strip()

    config_env = Path.home() / ".config" / "advent-of-code" / "session"
    if config_env.is_file():
        for line in config_env.read_text().splitlines():
            if line.startswith("SESSION="):
                return line.split("=", 1)[1].strip()

    raise RuntimeError(
        "SESSION not set and no config found at "
        f"{config_env}. Please create it with SESSION=..."
    )

def main(argv):
    if len(argv) < 2:
        print("Usage: fetch-input <day> [year]", file=sys.stderr)
        return 1

    try:
        day = int(argv[1])
    except ValueError:
        print("Day must be an integer", file=sys.stderr)
        return 1

    year = int(argv[2]) if len(argv) >= 3 else 2024

    day_dir = Path.cwd()
    data_dir = day_dir / "data"
    data_dir.mkdir(exist_ok=True)

    session = load_session()
    url = f"https://adventofcode.com/{year}/day/{day}/input"

    import requests

    resp = requests.get(
        url,
        headers={"User-Agent": "aoc-input-request (github.com/ham-munculus)"},
        cookies={"session": session},
    )

    if resp.status_code != 200:
        print(
            f"Error fetching input: HTTP {resp.status_code}\n"
            f"Response body:\n{resp.text}",
            file=sys.stderr,
        )
        return 1

    (data_dir / "input").write_text(resp.text)
    print(f"Fetched day {day} ({year}) -> {data_dir / 'input'}")
    return 0

if __name__ == "__main__":
    raise SystemExit(main(sys.argv))
PYCODE
